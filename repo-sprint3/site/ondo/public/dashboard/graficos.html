<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="../css/style.css">

  <link rel="stylesheet" href="dashboard.css">
  <link rel="stylesheet" href="menuLateral.css">
  <link rel="stylesheet" href="graficos.css" />

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>


  <title>Grafico</title>
</head>

<body onload="buscarTemperaturaMaxima(), buscarTemperaturaMinima(), buscarQuantidadeAlerta(),
obterDadosGraficoBarraAlertaBaixo(barraAlertaAbaixo), obterDadosGraficoBarraAlertaAcima(barraAlertaAcima),
buscarMensagemAlerta()">
  <header class="menu_dashboard">
    <nav class="menuLateral">
      <img src="../assets/img/logo_branco.png" alt="">
      <ul class="container_lista">
        <li class="menu_item">
          <div class="container_img">
            <img src="../assets/img/Dashboard/House_branco.svg" alt="">
          </div>
          <a href="./index.html">Home</a>
        </li>
        <li class="menu_item select">
          <div class="container_img disable" style="height: 25px;">
            <img src="../assets/img/Dashboard/chart-line-solid_verde.svg" alt="">
          </div>
          <a href="graficos.html">Graficos</a>
        </li>
        <li class="menu_item disable">
          <div class="container_img disable">
            <img src="../assets/img/Dashboard/bell-regular_branco.svg" alt="">
          </div>
          <a href="notificacao.html">Notificação</a>
        </li>

        <li class="menu_item disable">
          <div class="container_img disable">
            <img src="../assets/img/Dashboard/info_branco.svg" alt="">
          </div>
          <a href="help.html">Ajuda e Suporte</a>
        </li>

        <li class="menu_item disable">
          <div class="container_img disable">
            <img src="../assets/img/Dashboard/sair.svg" alt="">
          </div>
          <a href="../index.html">Sair</a>
        </li>
      </ul>
    </nav>
  </header>
  <main class="grafico_dashboard">
    <div class="boasVindas">
      <div class="container">
        <h3>Inicio</h3>
        <h5>Bem vindo, <b id="b_usuario"></b></h5>
      </div>
    </div>
    <div class="content">
      <div class="kpi_cards">
        <div class="card">
          <div class="kpi_titulo">
            <span>Temperaturas Atual</span>
            <img src="../assets/img/Dashboard/termometro.svg" alt="">
          </div>
          <div class="kpi_dado">
            <h2 id="h2_temperatura_real"></h2>
          </div>
        </div>
        <div class="card">
          <div class="kpi_titulo">
            <span>Alertas</span>
            <img src="../assets/img/Dashboard/danger.svg" alt="" class="img_sino">
          </div>
          <div class="kpi_dado">
            <h2 id="quantidade_alerta_kpi"></h2>
          </div>

        </div>
        <div class="card">
          <div class="kpi_titulo">
            <span>Temperaturas Maxima</span>
            <img src="../assets/img/Dashboard/TempAlta.svg" alt="">
          </div>
          <div class="kpi_dado">
            <h2 id="temperatura_maxima_kpi"></h2>
          </div>

        </div>
        <div class="card">
          <div class="kpi_titulo">
            <span>Temperaturas Minima</span>
            <img src="../assets/img/Dashboard/TempBaixa.svg" alt="">
          </div>
          <div class="kpi_dado">
            <h2 id="temperatura_minima_kpi"></h2>
          </div>

        </div>
      </div>

      <div class="grafico_cards" style="display: flex;">
        <div style="display: flex;" class="grafico_container">

          <div class="grafico">
            <!-- <h3>Análise de Temperaturas</h3> -->
            <canvas id="grafico_barra_abaixo" style="height: 100%; width: 100%;"></canvas>

          </div>
        </div>
      </div>

      <div class="grafico_cards">

        <div style="display: flex;" class="grafico_container">

          <div class="grafico">          
            <div class="container">
              <canvas id="grafico_barra_acima" style="padding-left: 20px;"></canvas>
            </div>
          </div>
        </div>
      </div>

      <div class="grafico_cards">
        <canvas class="grafico" id="grafico_linha"></canvas>
      </div>

      <section id="div_mensagem_alerta" class="notificacoes_recentes">
        <div class="titulos">
          <span>NO</span>
          <span>Localização</span>
          <span>Data</span>
          <span>Hora</span>
          <span>Mensagem</span>
        </div>
      </section>
    </div>
  </main>
</body>

</html>

<script>
  const graficoBarraAbaixo = document.getElementById("grafico_barra_abaixo");
  const graficoLinha = document.getElementById("grafico_linha");
  const graficoBarraAcima = document.getElementById("grafico_barra_acima");
  var idEstufaDashboard = 1;

  b_usuario.innerHTML = sessionStorage.NOME_RESPONSAVEL;

  var barraAlertaAbaixo = new Chart(graficoBarraAbaixo, {
    type: "bar",
    data: {
      labels: ["Temperatura"],
      datasets: [
        {
          label: "Alerta",
          borderWidth: 1,
        },
        {
          label: "Total de aferição",
          borderWidth: 1,
        },
      ],
    },
    options: {
      plugins: {
        title: {
          display: true, // Define se o título deve ser exibido
          text: "Alerta abaixo da Temperatura", // O texto do título
          font: {
            size: 20, // Tamanho da fonte do título
            weight: "bold", // Peso da fonte do título
          },
          padding: {
            top: 10, // Espaçamento acima do título
            bottom: 30, // Espaçamento abaixo do título
          },
        },
      },
      scales: {
        y: {
          beginAtZero: true,
        },
      },
    },
  });
  var linha = new Chart(graficoLinha, {
    type: "line",
    data: {
      datasets: [
        {
          label: "Temperatura",
          borderWidth: 1,
          borderColor: 'pink',
        },
        {
        label: 'Max',
        data: [21, 21, 21, 21, 21, 21, 21, 21, 21, 21], // Dados para a Linha 1
        borderColor: 'red', // Cor da linha
        fill: false, // Sem preenchimento abaixo da linha
      },
      {
        label: 'Min',
        data: [8, 8, 8, 8, 8, 8, 8, 8, 8, 8], // Dados para a Linha 1
        borderColor: 'blue', // Cor da linha
        fill: false, // Sem preenchimento abaixo da linha
      },
      ],
    },
    options: {
      plugins: {
        title: {
          display: true, // Define se o título deve ser exibido
          text: "Variação Horária de Temperatura", // O texto do título
          font: {
            size: 20, // Tamanho da fonte do título
            weight: "bold", // Peso da fonte do título
          },
          padding: {
            top: 10, // Espaçamento acima do título
            bottom: 30, // Espaçamento abaixo do título
          },
        },
      },
      scales: {
        y: {
          beginAtZero: true,
        },
      },
    },
  });

  var barraAlertaAcima = new Chart(graficoBarraAcima, {
    type: "bar",
    data: {
      labels: ["Temperatura"],
      datasets: [
        {
          label: "Alerta",
          borderWidth: 1,
        },
        {
          label: "Total de aferição",
          borderWidth: 1,
        },
      ],
    },
    options: {
      plugins: {
        title: {
          display: true, // Define se o título deve ser exibido
          text: "Alerta acima da Temperatura", // O texto do título
          font: {
            size: 20, // Tamanho da fonte do título
            weight: "bold", // Peso da fonte do título
          },
          padding: {
            top: 10, // Espaçamento acima do título
            bottom: 30, // Espaçamento abaixo do título
          },
        },
      },
      scales: {
        y: {
          beginAtZero: true,
        },
      },
    },
  });

  function obterDadosGraficoBarraAlertaBaixo(grafico) {
    fetch(`/graficos/alerta-abaixo/${idEstufaDashboard}`,{
      method: "GET",
    })
      .then(response => response.json())
      .then(valores => {          
          grafico.data.datasets[0].data.push(parseFloat(valores.quantidadeAlerta));
          grafico.data.datasets[1].data.push(parseFloat(valores.total));
          grafico.update();
      })
      .catch(error => console.error('Erro ao obter dados:', error));
  }

  function obterDadosGraficoBarraAlertaAcima(grafico) {
    fetch(`/graficos/alerta-acima/${idEstufaDashboard}`,{
      method: "GET",
    })
      .then(response => response.json())
      .then(valores => {          
          grafico.data.datasets[0].data.push(parseFloat(valores.quantidadeAlerta));
          grafico.data.datasets[1].data.push(parseFloat(valores.total));
          grafico.update();
      })
      .catch(error => console.error('Erro ao obter dados:', error));
  }

  function obterDadosGraficoLinha(grafico) {
    fetch(`/graficos/lista-temperatura-dia/${idEstufaDashboard}`,{
      method: "GET",
    })
      .then(response => response.json())
      .then(valores => {

        valores.forEach((valor) => {
          if (grafico.data.labels.length == 10 && grafico.data.datasets[0].data.length == 10) {
            grafico.data.labels.shift();
            grafico.data.datasets[0].data.shift();
            grafico.data.datasets[1].data.shift();
            grafico.data.datasets[2].data.shift();
          }

          grafico.data.labels.push(valor.hora);
          grafico.data.datasets[0].data.push(parseFloat(valor.temperatura));
          grafico.data.datasets[1].data.push(21);
          grafico.data.datasets[2].data.push(8);
          grafico.update();
        });
      })
      .catch(error => console.error('Erro ao obter dados:', error));
  }

  function temperaturaReal() {
    fetch(`/graficos/temperatura-atual/${idEstufaDashboard}`, {
      method: "GET",
    })
      .then(function (resposta) {
        resposta.json().then((temperatura) => {
          h2_temperatura_real.innerHTML = `${temperatura[0].temperatura_atual}°C`
        });
      })
      .catch(function (resposta) {
        console.log(`#ERRO: ${resposta}`);
      });
  }

  function buscarQuantidadeAlerta() {
    fetch(`/graficos/quantidade-alerta/${idEstufaDashboard}`, {
      method: "GET",
    })
      .then(function (resposta) {
        resposta.json().then((alertas) => {
          quantidade_alerta_kpi.innerHTML = `${alertas[0].quantidade_alertas}`
        });
      })
      .catch(function (resposta) {
        console.log(`#ERRO: ${resposta}`);
      });
  }

  function buscarTemperaturaMaxima() {
    fetch(`/graficos/temperatura-maxima/${idEstufaDashboard}`, {
      method: "GET",
    })
      .then(function (resposta) {
        resposta.json().then((temperatura) => {
          temperatura_maxima_kpi.innerHTML = `${temperatura[0].temperatura_maxima}°C`
        });
      })
      .catch(function (resposta) {
        console.log(`#ERRO: ${resposta}`);
      });
  }

  function buscarTemperaturaMinima() {
    fetch(`/graficos/temperatura-minima/${idEstufaDashboard}`, {
      method: "GET",
    })
      .then(function (resposta) {
        resposta.json().then((temperatura) => {
          temperatura_minima_kpi.innerHTML = `${temperatura[0].temperatura_minima}°C`
        });
      })
      .catch(function (resposta) {
        console.log(`#ERRO: ${resposta}`);
      });
  }

  function buscarMensagemAlerta() {
    fetch(`/graficos/lista-mensagem-alerta/${idEstufaDashboard}`, {
      method: "GET",
    })
      .then(function (resposta) {
        resposta.json().then((mensagens) => {
          console.log(mensagens)
          mensagens.forEach((mensagem, index) =>{
            console.log(mensagem)
            var dataLocal = new Date(mensagem.data);
            var dia = dataLocal.getDate().toString().padStart(2, '0');
            var mes = (dataLocal.getMonth() + 1).toString().padStart(2, '0');
            var ano = dataLocal.getFullYear();
            var dataFormatadaPTBR = `${dia}/${mes}/${ano}`;
            div_mensagem_alerta.innerHTML += `
            <div class="dados">
              <span>${index + 1}</span>
              <span>${mensagem.localidade}</span>
              <span>${dataFormatadaPTBR}</span>
              <span>${mensagem.hora}</span>
              <span>${mensagem.mensagem}</span>
            </div>`
          })
        });
      })
      .catch(function (resposta) {
        console.log(`#ERRO: ${resposta}`);
      });
  }

  setInterval(() => {
    obterDadosGraficoLinha(linha);
  }, 5000);

  setInterval(() => {
    temperaturaReal()
  }, 1000);


</script>